<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZZZ神秘小算盘</title>
    <!-- 引入 Chart.js 用于绘图 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- 核心变量定义 --- */
        :root {
            --zzz-neon: #dfff00;       /* 标志性荧光绿 */
            --zzz-green-highlight: #00ff9d; /* 最佳收益高亮绿 */
            --zzz-black: #080808;      /* 深邃黑 */
            --zzz-panel: #141414;      /* 面板背景 */
            --zzz-gray: #2a2a2a;       /* 输入框背景 */
            --zzz-border: #444;        /* 边框色 */
            --zzz-text-main: #fff;     /* 主文本 */
            --zzz-text-sub: #888;      /* 副文本 */
            --scanline-color: rgba(0, 0, 0, 0.5);
        }

        /* --- 基础样式 --- */
        body {
            background-color: var(--zzz-black);
            color: var(--zzz-text-main);
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
            background-image: 
                linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%),
                linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
        }

        /* 顶部标题栏 */
        header {
            width: 100%;
            max-width: 1200px;
            border-bottom: 2px solid var(--zzz-neon);
            margin-bottom: 30px;
            padding-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            position: relative;
        }

        h1 {
            margin: 0;
            font-size: 2rem;
            text-transform: uppercase;
            font-weight: 900;
            font-style: italic;
            letter-spacing: -1px;
            color: var(--zzz-text-main);
            text-shadow: 2px 2px 0px #333;
        }

        h1 span {
            color: var(--zzz-neon);
        }

        .header-deco {
            font-size: 0.8rem;
            color: var(--zzz-neon);
            background: var(--zzz-gray);
            padding: 2px 8px;
            border: 1px solid var(--zzz-neon);
            font-family: monospace;
        }

        /* --- 主布局 --- */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            width: 100%;
            max-width: 1200px;
        }

        /* --- 卡片面板通用样式 --- */
        .panel {
            background: var(--zzz-panel);
            border: 1px solid var(--zzz-border);
            padding: 25px;
            position: relative;
            clip-path: polygon(
                0 0, 
                100% 0, 
                100% calc(100% - 20px), 
                calc(100% - 20px) 100%, 
                0 100%
            );
        }

        .panel::before {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 22px;
            height: 2px;
            background: var(--zzz-neon);
            transform: rotate(-45deg);
            transform-origin: bottom right;
        }

        .panel-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--zzz-neon);
            text-transform: uppercase;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            border-left: 4px solid var(--zzz-neon);
            padding-left: 10px;
            background: linear-gradient(90deg, rgba(223, 255, 0, 0.1), transparent);
        }

        .sub-panel-title {
            font-size: 0.9rem;
            color: #888;
            border-bottom: 1px solid #333;
            margin: 15px 0 10px 0;
            padding-bottom: 5px;
            font-weight: bold;
        }

        /* --- 输入框组 --- */
        .input-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding: 5px 0;
            border-bottom: 1px dashed #333;
        }

        .input-group:last-child {
            border-bottom: none;
        }

        .input-group label {
            font-size: 0.9rem;
            color: #ccc;
            flex: 1;
        }

        .input-wrapper {
            display: flex;
            align-items: center;
            background: var(--zzz-gray);
            border: 1px solid #444;
            padding: 2px 8px;
            transform: skewX(-10deg);
        }

        .input-wrapper:focus-within {
            border-color: var(--zzz-neon);
            box-shadow: 0 0 5px rgba(223, 255, 0, 0.3);
        }

        .input-wrapper.disabled {
            background: #111;
            border-color: #222;
            cursor: not-allowed;
        }
        
        .input-wrapper.read-only {
            background: #181818;
            border: 1px solid #333;
        }
        
        .input-wrapper.read-only input {
            color: #888;
        }

        .input-group input, .input-group select {
            background: transparent;
            border: none;
            color: var(--zzz-text-main);
            font-family: monospace;
            font-size: 1rem;
            width: 70px;
            text-align: right;
            outline: none;
            transform: skewX(10deg);
        }

        .input-group select {
            width: 140px;
            text-align: left;
            cursor: pointer;
            color: var(--zzz-neon);
        }

        .input-group select option {
            background: var(--zzz-black);
            color: #fff;
        }

        .unit {
            font-size: 0.8rem;
            color: #666;
            margin-left: 8px;
            transform: skewX(10deg);
            width: 15px;
        }

        /* --- 切换开关 (Weakness Toggle) --- */
        .toggle-container {
            display: flex;
            background: #111;
            border: 1px solid #444;
            transform: skewX(-10deg);
            overflow: hidden;
            cursor: pointer;
        }

        .toggle-btn {
            padding: 4px 12px;
            font-size: 0.9rem;
            color: #666;
            transition: all 0.2s;
            transform: skewX(10deg); 
        }

        .toggle-btn.active {
            background: var(--zzz-neon);
            color: #000;
            font-weight: bold;
        }

        /* --- 结果面板 --- */
        .result-container {
            grid-column: 1 / -1;
            margin-top: 20px;
            background: black;
            border: 2px solid var(--zzz-neon);
            text-align: center;
            padding: 30px;
            position: relative;
            box-shadow: 0 0 20px rgba(223, 255, 0, 0.1);
        }

        .formula-display {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85rem;
            color: #aaa;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(20, 20, 20, 0.8);
            border: 1px solid #333;
            border-radius: 4px;
            word-break: break-all;
            line-height: 1.5;
            text-align: left;
        }

        .formula-display span.highlight {
            color: var(--zzz-neon);
        }

        .result-label {
            color: var(--zzz-text-sub);
            font-size: 0.9rem;
            letter-spacing: 2px;
            margin-bottom: 10px;
        }

        .result-value {
            font-size: 4rem;
            font-weight: 900;
            color: var(--zzz-neon);
            font-family: 'Impact', sans-serif;
            text-shadow: 4px 4px 0px rgba(255, 255, 255, 0.2);
            line-height: 1;
        }

        .sub-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
            font-size: 0.85rem;
            color: #666;
            font-family: monospace;
        }

        .sub-stats span strong {
            color: #aaa;
        }

        /* --- 收益分析面板 --- */
        .gain-panel {
            grid-column: 1 / -1;
            border-top: 4px solid var(--zzz-neon);
        }
        
        .disk-select-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
            background: #1a1a1a;
            padding: 15px;
            border: 1px solid #333;
        }

        .disk-select-item label {
            display: block;
            color: #ccc;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .disk-select-item select {
            width: 100%;
            background: #222;
            border: 1px solid #444;
            color: #fff;
            padding: 8px;
            font-family: monospace;
        }

        .disk-select-item select option.best-opt {
            color: var(--zzz-green-highlight);
            font-weight: bold;
        }

        .disk-best-display {
            grid-column: 1 / -1;
            text-align: center;
            padding-top: 10px;
            border-top: 1px dashed #444;
            font-size: 0.9rem;
            color: #888;
        }

        .disk-best-val {
            color: var(--zzz-green-highlight);
            font-weight: bold;
            font-size: 1.1rem;
        }

        /* 副词条表格 */
        .gain-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .gain-item {
            background: #222;
            padding: 15px;
            border: 1px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }
        
        .gain-item.best-gain {
            border-color: var(--zzz-green-highlight);
            box-shadow: 0 0 10px rgba(0, 255, 157, 0.1);
        }
        
        .gain-item.best-gain::after {
            content: 'MAX';
            position: absolute;
            top: -8px;
            right: -5px;
            background: var(--zzz-green-highlight);
            color: black;
            font-size: 0.6rem;
            padding: 2px 4px;
            font-weight: bold;
        }
        
        .gain-label {
            font-size: 0.85rem;
            color: #ccc;
        }
        
        .gain-value {
            font-family: monospace;
            font-size: 1.1rem;
            color: #aaa;
        }
        
        .gain-value.positive {
            color: var(--zzz-neon);
        }
        
        .gain-item.best-gain .gain-value {
            color: var(--zzz-green-highlight);
            font-weight: bold;
        }

        /* --- 自动模拟器面板 --- */
        .sim-panel {
            grid-column: 1 / -1;
            margin-top: 20px;
            border-top: 4px solid #ff0055; /* 区分颜色 */
        }
        
        .sim-title {
            color: #ff0055 !important;
            border-left-color: #ff0055 !important;
            background: linear-gradient(90deg, rgba(255, 0, 85, 0.1), transparent) !important;
        }

        .sim-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 25px;
        }

        .sim-btn {
            background: #1a1a1a;
            border: 1px solid #444;
            color: #fff;
            padding: 10px 20px;
            font-family: monospace;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            flex: 1;
            text-align: center;
        }

        .sim-btn:hover {
            border-color: #ff0055;
            background: #222;
        }

        .sim-btn:active {
            transform: translateY(2px);
        }

        .sim-results {
            background: #111;
            border: 1px solid #333;
            padding: 20px;
            display: none; /* 默认隐藏 */
        }

        .sim-results.show {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .sim-stat-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 调整为3列 */
            gap: 10px;
            margin-bottom: 20px;
        }

        .sim-stat-box {
            background: #222;
            border: 1px solid #444;
            padding: 10px;
            text-align: center;
        }

        .sim-stat-name {
            font-size: 0.75rem;
            color: #888;
            margin-bottom: 5px;
        }

        .sim-stat-count {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ff0055;
            font-family: monospace;
        }

        .sim-summary {
            border-top: 1px dashed #333;
            padding-top: 15px;
            font-family: monospace;
            font-size: 0.9rem;
            color: #ccc;
            line-height: 1.6;
        }

        .sim-final-dmg {
            font-size: 1.5rem;
            color: #ff0055;
            font-weight: bold;
            display: block;
            margin-top: 5px;
        }

        /* 最终面板详情 */
        .sim-final-stats-container {
            margin-top: 20px;
            border: 1px solid #333;
            background: #181818;
            padding: 15px;
        }
        
        .sim-final-stats-header {
            font-size: 0.9rem;
            color: #ccc;
            margin-bottom: 10px;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }

        .sim-final-stats-list {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.9rem;
        }

        .sim-final-stat-row {
            display: flex;
            justify-content: space-between;
            color: #888;
        }

        .sim-final-stat-val {
            color: var(--zzz-neon);
            font-family: monospace;
        }

        /* 图表容器 */
        .chart-container {
            margin-top: 20px;
            height: 300px;
            width: 100%;
            background: #151515;
            border: 1px solid #333;
            padding: 10px;
            box-sizing: border-box;
        }

        .deco-corner {
            position: absolute;
            width: 10px;
            height: 10px;
            border: 2px solid var(--zzz-neon);
            transition: all 0.3s;
        }
        .tl { top: -2px; left: -2px; border-right: none; border-bottom: none; }
        .tr { top: -2px; right: -2px; border-left: none; border-bottom: none; }
        .bl { bottom: -2px; left: -2px; border-right: none; border-top: none; }
        .br { bottom: -2px; right: -2px; border-left: none; border-top: none; }

        .formula-box {
            grid-column: 1 / -1;
            margin-top: 20px;
            padding: 15px;
            background: #111;
            border-left: 2px solid #333;
            color: #555;
            font-size: 0.75rem;
            font-family: monospace;
            word-break: break-all;
            text-align: center;
        }

    </style>
</head>
<body>

    <header>
        <h1>ZZZ <span>DMG.CALC</span></h1>
        <div class="header-deco">SYS_READY // V.3.1</div>
    </header>

    <div class="grid-container">
        
        <!-- 代理人面板 -->
        <div class="panel">
            <div class="panel-title">PROXY DATA // 代理人数据</div>
            
            <div class="input-group">
                <label>技能倍率</label>
                <div class="input-wrapper">
                    <input type="number" id="skillMult" value="100">
                    <span class="unit">%</span>
                </div>
            </div>

            <!-- 攻击力拆解部分 -->
            <div style="margin-bottom: 10px; border:1px dashed #333; padding:10px; background:#181818;">
                <div class="sub-panel-title" style="margin-top:0;">BASE ATK COMPONENTS</div>
                
                <div class="input-group">
                    <label>代理人基础攻击</label>
                    <div class="input-wrapper">
                        <input type="number" id="agent_base_atk" value="800">
                        <span class="unit"> </span>
                    </div>
                </div>
                
                <div class="input-group">
                    <label>音擎基础攻击</label>
                    <div class="input-wrapper">
                        <input type="number" id="weapon_base_atk" value="594">
                        <span class="unit"> </span>
                    </div>
                </div>

                <div class="input-group">
                    <label style="color:#888;">6号位主词条(Atk%)</label>
                    <div class="input-wrapper read-only disabled">
                        <input type="number" value="30" disabled>
                        <span class="unit">%</span>
                    </div>
                </div>

                <div class="input-group">
                    <label style="color:#888;">2号位主词条(Flat)</label>
                    <div class="input-wrapper read-only disabled">
                        <input type="number" value="316" disabled>
                        <span class="unit"> </span>
                    </div>
                </div>
            </div>

            <!-- 4号位主词条选择 -->
            <div class="input-group">
                <label style="color:var(--zzz-green-highlight);">4号位主词条</label>
                <div class="input-wrapper">
                    <select id="slot4_main" onchange="calculateDamage()">
                        <option value="none">无 (None)</option>
                        <option value="cr_24">暴击率 24%</option>
                        <option value="cd_48">暴击伤害 48%</option>
                        <option value="atk_30">攻击力 30%</option>
                    </select>
                </div>
            </div>
            
            <div class="input-group">
                <label style="color:var(--zzz-green-highlight);">局内攻击力(%)</label>
                <div class="input-wrapper">
                    <input type="number" id="agent_inAtkPct" value="0">
                    <span class="unit">%</span>
                </div>
            </div>

            <div class="input-group">
                <label style="color:var(--zzz-green-highlight);">局内攻击力(固定)</label>
                <div class="input-wrapper">
                    <input type="number" id="agent_inAtkFlat" value="0">
                    <span class="unit"> </span>
                </div>
            </div>

            <div class="input-group">
                <label>暴击率</label>
                <div class="input-wrapper">
                    <input type="number" id="critRate" value="50">
                    <span class="unit">%</span>
                </div>
            </div>

            <div class="input-group">
                <label>暴击伤害</label>
                <div class="input-wrapper">
                    <input type="number" id="critDmg" value="100">
                    <span class="unit">%</span>
                </div>
            </div>

            <div class="input-group">
                <label>增伤</label>
                <div class="input-wrapper">
                    <input type="number" id="dmgBonus" value="30">
                    <span class="unit">%</span>
                </div>
            </div>

            <div style="height: 10px; border-bottom: 1px dashed #333; margin-bottom: 15px;"></div>

            <div class="input-group">
                <label>穿透率</label>
                <div class="input-wrapper">
                    <input type="number" id="penRatio" value="0">
                    <span class="unit">%</span>
                </div>
            </div>

            <div class="input-group">
                <label>穿透值</label>
                <div class="input-wrapper">
                    <input type="number" id="penValue" value="0">
                    <span class="unit"> </span>
                </div>
            </div>

            <div class="input-group">
                <label>无视防御 (减防)</label>
                <div class="input-wrapper">
                    <input type="number" id="defShred" value="0">
                    <span class="unit">%</span>
                </div>
            </div>

            <div class="input-group">
                <label>失衡易伤</label>
                <div class="input-wrapper">
                    <input type="number" id="stunMult" value="0">
                    <span class="unit">%</span>
                </div>
            </div>

            <div class="input-group">
                <label>代理人减抗</label>
                <div class="input-wrapper">
                    <input type="number" id="agentResRed" value="0">
                    <span class="unit">%</span>
                </div>
            </div>
        </div>

        <!-- 队友增益面板 -->
        <div class="panel">
            <div class="panel-title">TEAM BUFFS // 队友增益</div>
            
            <div class="sub-panel-title">TEAMMATE 1</div>
            <div class="input-group">
                <label>暴击率</label>
                <div class="input-wrapper"><input type="number" id="tm1_critRate" value="0"><span class="unit">%</span></div>
            </div>
            <div class="input-group">
                <label>暴击伤害</label>
                <div class="input-wrapper"><input type="number" id="tm1_critDmg" value="0"><span class="unit">%</span></div>
            </div>
            <div class="input-group">
                <label style="color:var(--zzz-green-highlight);">局内攻击 (%)</label>
                <div class="input-wrapper"><input type="number" id="tm1_inAtkPct" value="0"><span class="unit">%</span></div>
            </div>
            <div class="input-group">
                <label style="color:var(--zzz-green-highlight);">局内攻击 (固定)</label>
                <div class="input-wrapper"><input type="number" id="tm1_inAtkFlat" value="0"><span class="unit"> </span></div>
            </div>
            <div class="input-group">
                <label>增伤</label>
                <div class="input-wrapper"><input type="number" id="tm1_dmgBonus" value="0"><span class="unit">%</span></div>
            </div>
            <div class="input-group">
                <label>代理人减抗</label>
                <div class="input-wrapper"><input type="number" id="tm1_resRed" value="0"><span class="unit">%</span></div>
            </div>
            <div class="input-group">
                <label>失衡易伤</label>
                <div class="input-wrapper"><input type="number" id="tm1_stunMult" value="0"><span class="unit">%</span></div>
            </div>
            <div class="input-group">
                <label>穿透率</label>
                <div class="input-wrapper"><input type="number" id="tm1_penRatio" value="0"><span class="unit">%</span></div>
            </div>

            <div class="sub-panel-title" style="margin-top: 25px;">TEAMMATE 2</div>
            <div class="input-group">
                <label>暴击率</label>
                <div class="input-wrapper"><input type="number" id="tm2_critRate" value="0"><span class="unit">%</span></div>
            </div>
            <div class="input-group">
                <label>暴击伤害</label>
                <div class="input-wrapper"><input type="number" id="tm2_critDmg" value="0"><span class="unit">%</span></div>
            </div>
            <div class="input-group">
                <label style="color:var(--zzz-green-highlight);">局内攻击 (%)</label>
                <div class="input-wrapper"><input type="number" id="tm2_inAtkPct" value="0"><span class="unit">%</span></div>
            </div>
            <div class="input-group">
                <label style="color:var(--zzz-green-highlight);">局内攻击 (固定)</label>
                <div class="input-wrapper"><input type="number" id="tm2_inAtkFlat" value="0"><span class="unit"> </span></div>
            </div>
            <div class="input-group">
                <label>增伤</label>
                <div class="input-wrapper"><input type="number" id="tm2_dmgBonus" value="0"><span class="unit">%</span></div>
            </div>
            <div class="input-group">
                <label>代理人减抗</label>
                <div class="input-wrapper"><input type="number" id="tm2_resRed" value="0"><span class="unit">%</span></div>
            </div>
            <div class="input-group">
                <label>失衡易伤</label>
                <div class="input-wrapper"><input type="number" id="tm2_stunMult" value="0"><span class="unit">%</span></div>
            </div>
            <div class="input-group">
                <label>穿透率</label>
                <div class="input-wrapper"><input type="number" id="tm2_penRatio" value="0"><span class="unit">%</span></div>
            </div>
        </div>

        <!-- 敌人面板 -->
        <div class="panel">
            <div class="panel-title">TARGET DATA // 敌人数据</div>

            <div class="input-group">
                <label>基础防御力</label>
                <div class="input-wrapper">
                    <input type="number" id="baseDef" value="800">
                    <span class="unit"> </span>
                </div>
            </div>

            <div class="input-group">
                <label>防御加成</label>
                <div class="input-wrapper">
                    <input type="number" id="defBonus" value="0">
                    <span class="unit">%</span>
                </div>
            </div>

            <div style="height: 10px; border-bottom: 1px dashed #333; margin-bottom: 15px;"></div>

            <div class="input-group">
                <label>敌人抗性</label>
                <div class="input-wrapper" id="resInputWrapper">
                    <input type="number" id="enemyRes" value="20">
                    <span class="unit">%</span>
                </div>
            </div>

            <div class="input-group">
                <label>敌人弱点 (Weakness)</label>
                <!-- 切换开关 -->
                <div class="toggle-container" onclick="toggleWeakness(this)">
                    <div class="toggle-btn" id="weaknessNo">NO</div>
                    <div class="toggle-btn active" id="weaknessYes">YES</div>
                    <!-- 隐藏存储值 -->
                    <input type="hidden" id="enemyWeakness" value="20">
                </div>
            </div>

            <div style="margin-top: 50px; border: 1px solid #333; padding: 10px; text-align: center; color: #444; font-size: 0.7rem; font-family: monospace;">
                bY 奥博勒斯的千早爱音本人<br>
                and Dr.Gemini
            </div>
        </div>

        <!-- 结果面板 -->
        <div class="result-container panel">
            <!-- 四角装饰 -->
            <div class="deco-corner tl"></div>
            <div class="deco-corner tr"></div>
            <div class="deco-corner bl"></div>
            <div class="deco-corner br"></div>

            <div class="result-label">CALCULATION FORMULA // 计算过程</div>
            <div id="formulaDisplay" class="formula-display"></div>

            <div class="result-label">EXPECTED DAMAGE // 期望伤害</div>
            <div class="result-value" id="finalResult">0</div>
            
            <div class="sub-stats">
                <span>防御区: <strong id="defMultDisplay">--</strong></span>
                <span>|</span>
                <span>抗性区: <strong id="resMultDisplay">--</strong></span>
            </div>
        </div>

        <!-- 收益分析面板 -->
        <div class="panel gain-panel">
            <div class="panel-title">GAIN ANALYSIS // 收益分析</div>
            
            <div class="input-group" style="margin-bottom: 20px;">
                <label style="color: var(--zzz-neon);">基础攻击力 (白值)</label>
                <div class="input-wrapper read-only">
                    <input type="number" id="baseAttackInput" value="0" disabled title="自动计算 (代理人+音擎)">
                    <span class="unit"> </span>
                </div>
            </div>

            <!-- 驱动盘配置 (新版) -->
            <div class="disk-select-container">
                <div class="disk-select-item">
                    <label>5号位主词条 (Slot 5)</label>
                    <select id="slot5_main" onchange="calculateDamage()">
                        <option value="none">无 (None)</option>
                        <option value="atk_30">攻击力 +30% (Atk)</option>
                        <option value="dmg_30">增伤 +30% (Dmg)</option>
                        <option value="pen_24">穿透率 +24% (Pen)</option>
                    </select>
                </div>

                <div class="disk-select-item">
                    <label>2件套效果 (2-Pc Set)</label>
                    <select id="set2_effect" onchange="calculateDamage()">
                        <option value="none">无 (None)</option>
                        <option value="atk_10">攻击力 +10% (Atk)</option>
                        <option value="dmg_10">增伤 +10% (Dmg)</option>
                        <option value="pen_8">穿透率 +8% (Pen)</option>
                        <option value="cd_16">暴击伤害 +16% (CD)</option>
                        <!-- 移除了暴击率 +8% -->
                    </select>
                </div>

                <div class="disk-best-display">
                    当前选择下伤害 <span id="currentDiskDmg">0</span><br>
                    最优组合: <span id="bestDiskCombo" class="disk-best-val">--</span> <br>
                    <span style="font-size:0.8rem">相对于裸面板提升: <span id="diskGainVal">0%</span></span>
                </div>
            </div>

            <div style="font-size: 0.8rem; color: #666; margin-bottom: 10px;">如果添加以下单个副词条，伤害提升幅度 (基于当前状态)：</div>

            <!-- 副词条收益表格 (已移除穿透值) -->
            <div class="gain-grid">
                <div class="gain-item" id="gainItem_critRate">
                    <div class="gain-label">暴击率 <br><span style="font-size:0.7em; color:#666;">+2.4%</span></div>
                    <div class="gain-value" id="gainVal_critRate">--</div>
                </div>
                <div class="gain-item" id="gainItem_critDmg">
                    <div class="gain-label">暴击伤害 <br><span style="font-size:0.7em; color:#666;">+4.8%</span></div>
                    <div class="gain-value" id="gainVal_critDmg">--</div>
                </div>
                <!-- 穿透值已移除 -->
                <div class="gain-item" id="gainItem_atk">
                    <div class="gain-label">攻击力 <br><span style="font-size:0.7em; color:#666;">+3%</span></div>
                    <div class="gain-value" id="gainVal_atk">--</div>
                </div>
            </div>
        </div>

        <!-- 自动模拟器面板 -->
        <div class="panel sim-panel">
            <div class="panel-title sim-title">AUTO OPTIMIZER // 自动词条模拟</div>
            <div style="font-size:0.8rem; color:#aaa; margin-bottom: 15px; text-align: center;">
                模拟迭代寻找最优解 (Greedy Algorithm)
            </div>
            
            <div class="sim-controls">
                <button class="sim-btn" onclick="runSimulation(30)">[ 30 词条 ]</button>
                <button class="sim-btn" onclick="runSimulation(36)">[ 36 词条 ]</button>
                <button class="sim-btn" onclick="runSimulation(42)">[ 42 词条 ]</button>
            </div>

            <div id="simResults" class="sim-results">
                <!-- 统计计数 (穿透已移除) -->
                <div class="sim-stat-grid">
                    <div class="sim-stat-box">
                        <div class="sim-stat-name">暴击率 (Crit)</div>
                        <div class="sim-stat-count" id="simCountCritRate">0</div>
                    </div>
                    <div class="sim-stat-box">
                        <div class="sim-stat-name">暴击伤害 (CD)</div>
                        <div class="sim-stat-count" id="simCountCritDmg">0</div>
                    </div>
                    <div class="sim-stat-box">
                        <div class="sim-stat-name">攻击力 (Atk%)</div>
                        <div class="sim-stat-count" id="simCountAtk">0</div>
                    </div>
                </div>

                <div class="sim-summary">
                    <div>迭代次数: <span id="simTotalSteps" style="color:#fff;">0</span> Steps</div>
                    <div>初始伤害: <span id="simStartDmg">0</span></div>
                    <div style="margin-top:10px; border-top:1px dashed #333; padding-top:10px;">
                        最终伤害 (Simulated Final DMG):
                        <span id="simFinalDmg" class="sim-final-dmg">0</span>
                        <span style="font-size:0.8rem; color:#888;">提升幅度: <span id="simIncrease" style="color:var(--zzz-neon);">+0.00%</span></span>
                    </div>
                </div>
                
                <!-- 最终面板数值展示 -->
                <div class="sim-final-stats-container">
                    <div class="sim-final-stats-header">OPTIMIZED STATS // 最终面板数值</div>
                    <div class="sim-final-stats-list">
                        <div class="sim-final-stat-row">
                            <span>攻击力 (Atk):</span> <span id="finalStatAtk" class="sim-final-stat-val">--</span>
                        </div>
                        <div class="sim-final-stat-row">
                            <span>暴击率 (Crit):</span> <span id="finalStatCrit" class="sim-final-stat-val">--</span>
                        </div>
                        <div class="sim-final-stat-row">
                            <span>暴击伤害 (CD):</span> <span id="finalStatCD" class="sim-final-stat-val">--</span>
                        </div>
                        <div class="sim-final-stat-row">
                            <span>穿透值 (Pen):</span> <span id="finalStatPen" class="sim-final-stat-val">--</span>
                        </div>
                        <div class="sim-final-stat-row">
                            <span>穿透率 (Ratio):</span> <span id="finalStatPenRatio" class="sim-final-stat-val">--</span>
                        </div>
                        <div class="sim-final-stat-row">
                            <span>增伤 (Bonus):</span> <span id="finalStatDmgBonus" class="sim-final-stat-val">--</span>
                        </div>
                    </div>
                </div>

                <!-- 收益率图表 -->
                <div style="margin-top: 20px; font-size: 0.8rem; color: #aaa;">收益率趋势图 (Potential Gain Rate %)</div>
                <div class="chart-container">
                    <canvas id="gainChart"></canvas>
                </div>

            </div>
        </div>

        <div class="formula-box">
            公式: 技能倍率 * ((基础白值*局外%+局外固定)*(1+局内%)+局内固定) * (1+增伤) * (1+暴击*(1+爆伤)) * (1-敌人抗性+敌人弱点+减抗) * (794 / (((基础防御 * (1+防御加成-减防)) * (1-穿透率) - 穿透值) + 794)) * (1+失衡易伤)
        </div>

    </div>

    <script>
        // 获取显示元素
        const resultDisplay = document.getElementById('finalResult');
        const formulaDisplay = document.getElementById('formulaDisplay');
        const defMultDisplay = document.getElementById('defMultDisplay');
        const resMultDisplay = document.getElementById('resMultDisplay');
        
        // 收益显示元素
        const baseAttackInput = document.getElementById('baseAttackInput');
        const gainDisplays = {
            critRate: { el: document.getElementById('gainVal_critRate'), container: document.getElementById('gainItem_critRate') },
            critDmg: { el: document.getElementById('gainVal_critDmg'), container: document.getElementById('gainItem_critDmg') },
            // Removed Pen
            atk: { el: document.getElementById('gainVal_atk'), container: document.getElementById('gainItem_atk') }
        };
        
        // 模拟显示元素
        const simResults = document.getElementById('simResults');
        const simCountEls = {
            critRate: document.getElementById('simCountCritRate'),
            critDmg: document.getElementById('simCountCritDmg'),
            // Removed Pen
            atk: document.getElementById('simCountAtk')
        };
        const simSummaryEls = {
            steps: document.getElementById('simTotalSteps'),
            startDmg: document.getElementById('simStartDmg'),
            finalDmg: document.getElementById('simFinalDmg'),
            increase: document.getElementById('simIncrease')
        };
        // 最终面板元素
        const finalStatsEls = {
            atk: document.getElementById('finalStatAtk'),
            crit: document.getElementById('finalStatCrit'),
            cd: document.getElementById('finalStatCD'),
            pen: document.getElementById('finalStatPen'),
            penRatio: document.getElementById('finalStatPenRatio'),
            dmgBonus: document.getElementById('finalStatDmgBonus')
        };
        // 磁盘显示
        const diskDisplay = {
            currentDmg: document.getElementById('currentDiskDmg'),
            bestCombo: document.getElementById('bestDiskCombo'),
            gainVal: document.getElementById('diskGainVal'),
            selectSlot5: document.getElementById('slot5_main'),
            selectSet2: document.getElementById('set2_effect')
        };

        const inputs = document.querySelectorAll('input');

        let gainChart = null; // Chart instance
        let currentSimHistory = []; // Store history for tooltip

        // 弱点开关
        function toggleWeakness(el) {
            const yesBtn = el.querySelector('#weaknessYes');
            const noBtn = el.querySelector('#weaknessNo');
            const hiddenInput = el.querySelector('#enemyWeakness');
            const resInput = document.getElementById('enemyRes');
            const resWrapper = document.getElementById('resInputWrapper');
            
            if (yesBtn.classList.contains('active')) {
                // Switch to NO
                yesBtn.classList.remove('active');
                noBtn.classList.add('active');
                hiddenInput.value = 0;
                // Enable Res Input
                resInput.disabled = false;
                resWrapper.classList.remove('disabled');
            } else {
                // Switch to YES
                yesBtn.classList.add('active');
                noBtn.classList.remove('active');
                hiddenInput.value = 20;
                // Force Res to 0 and Disable
                resInput.value = 0;
                resInput.disabled = true;
                resWrapper.classList.add('disabled');
            }
            calculateDamage();
        }

        function calculateBaseDamage(stats) {
            const finalAttack = stats.attack * (1 + stats.inAtkPct) + stats.inAtkFlat;

            const dmgBonusMultiplier = 1 + stats.dmgBonus;
            const effectiveCritRate = Math.min(Math.max(stats.critRate, 0), 1.0); 
            const critMultiplier = 1 + (effectiveCritRate * (1 + stats.critDmg));
            const resMultiplier = 1 - stats.enemyRes + stats.enemyWeakness + stats.agentResRed;

            let currentDef = stats.baseDef * (1 + stats.defBonus - stats.defShred);
            let finalDefVal = (currentDef * (1 - stats.penRatio)) - stats.penValue;
            if (finalDefVal < 0) finalDefVal = 0; 
            
            let defMultiplier = 794 / (finalDefVal + 794);

            const stunMultiplier = 1 + stats.stunMult;

            let damage = stats.skillMult * finalAttack * dmgBonusMultiplier * critMultiplier * resMultiplier * defMultiplier * stunMultiplier;
            
            return { damage, defMultiplier, resMultiplier, effectiveCritRate, finalAttack };
        }

        function getRawInputs() {
            const getVal = (id, isPercent=false) => {
                const el = document.getElementById(id);
                if (!el) return 0;
                let val = parseFloat(el.value) || 0;
                return isPercent ? val / 100 : val;
            };

            // 1. Calculate Base (White) Attack
            const agentBase = getVal('agent_base_atk');
            const weaponBase = getVal('weapon_base_atk');
            const totalBase = agentBase + weaponBase;
            
            // Sync to read-only input
            document.getElementById('baseAttackInput').value = totalBase;

            // 2. Calculate Initial Panel Attack (Before sub-stats & disk selection)
            // Added Logic: Read Slot 4 Selection here to add to outside mult
            const slot4Select = document.getElementById('slot4_main').value;
            let slot4AtkMod = 0;
            if (slot4Select === 'atk_30') slot4AtkMod = 0.30;

            const slot6Mult = 0.30;
            const slot2Flat = 316;
            
            // Note: Slot 4 Atk% added to outside multiplier
            let initialPanelAtk = totalBase * (1 + slot6Mult + slot4AtkMod) + slot2Flat;

            // 3. Gather stats
            let stats = {
                skillMult: getVal('skillMult', true),
                attack: initialPanelAtk, // Start with this baseline
                baseAttack: totalBase,   // Store for % calcs
                inAtkPct: getVal('agent_inAtkPct', true),
                inAtkFlat: getVal('agent_inAtkFlat'),
                
                // Add Slot 4 Crit/CD mods here
                critRate: getVal('critRate', true) + (slot4Select === 'cr_24' ? 0.24 : 0),
                critDmg: getVal('critDmg', true) + (slot4Select === 'cd_48' ? 0.48 : 0),
                
                dmgBonus: getVal('dmgBonus', true),
                penRatio: getVal('penRatio', true),
                penValue: getVal('penValue'),
                defShred: getVal('defShred', true),
                stunMult: getVal('stunMult', true),
                agentResRed: getVal('agentResRed', true),
                
                baseDef: getVal('baseDef'),
                defBonus: getVal('defBonus', true),
                enemyRes: getVal('enemyRes', true),
                enemyWeakness: getVal('enemyWeakness', true),
                
                // Teammate Buffs
                tmBuffs: {
                    inAtkPct: getVal('tm1_inAtkPct', true) + getVal('tm2_inAtkPct', true),
                    inAtkFlat: getVal('tm1_inAtkFlat') + getVal('tm2_inAtkFlat'),
                    
                    crit: getVal('tm1_critRate', true) + getVal('tm2_critRate', true),
                    cd: getVal('tm1_critDmg', true) + getVal('tm2_critDmg', true),
                    dmg: getVal('tm1_dmgBonus', true) + getVal('tm2_dmgBonus', true),
                    resRed: getVal('tm1_resRed', true) + getVal('tm2_resRed', true),
                    stun: getVal('tm1_stunMult', true) + getVal('tm2_stunMult', true),
                    penRatio: getVal('tm1_penRatio', true) + getVal('tm2_penRatio', true)
                }
            };

            // 4. Merge Teammate Buffs
            // In-game Atk buffs
            stats.inAtkPct += stats.tmBuffs.inAtkPct;
            stats.inAtkFlat += stats.tmBuffs.inAtkFlat;
            
            // Other buffs
            stats.critRate += stats.tmBuffs.crit;
            stats.critDmg += stats.tmBuffs.cd;
            stats.dmgBonus += stats.tmBuffs.dmg;
            stats.agentResRed += stats.tmBuffs.resRed; 
            stats.stunMult += stats.tmBuffs.stun;
            stats.penRatio += stats.tmBuffs.penRatio;

            return stats;
        }

        // Apply disk drive mods (Outside buffs)
        function applyDiskMod(baseStats, slot5, set2) {
            let s = { ...baseStats };
            
            // Slot 5
            if (slot5 === 'atk_30') s.attack += (s.baseAttack * 0.30); // Add to Panel
            if (slot5 === 'dmg_30') s.dmgBonus += 0.30;
            if (slot5 === 'pen_24') s.penRatio += 0.24;
            
            // Set 2
            if (set2 === 'atk_10') s.attack += (s.baseAttack * 0.10); // Add to Panel
            if (set2 === 'dmg_10') s.dmgBonus += 0.10;
            if (set2 === 'pen_8') s.penRatio += 0.08;
            if (set2 === 'cd_16') s.critDmg += 0.16;
            // Removed cr_8

            return s;
        }

        function calculateBestDiskCombo(baseStats) {
            const slot5Opts = [
                { id: 'none', label: '无', val: 0 },
                { id: 'atk_30', label: '攻击', val: 0 },
                { id: 'dmg_30', label: '增伤', val: 0 },
                { id: 'pen_24', label: '穿透', val: 0 }
            ];
            const set2Opts = [
                { id: 'none', label: '无', val: 0 },
                { id: 'atk_10', label: '攻击', val: 0 },
                { id: 'dmg_10', label: '增伤', val: 0 },
                { id: 'pen_8', label: '穿透', val: 0 },
                { id: 'cd_16', label: '爆伤', val: 0 }
                // Removed cr_8
            ];

            let bestDmg = -1;
            let bestCombo = { s5: 'none', s2: 'none', label: '' };

            // Base dmg (no mod) for comparison
            const nakedDmg = calculateBaseDamage(baseStats).damage;

            slot5Opts.forEach(s5 => {
                set2Opts.forEach(s2 => {
                    const modStats = applyDiskMod(baseStats, s5.id, s2.id);
                    const res = calculateBaseDamage(modStats);
                    if (res.damage > bestDmg) {
                        bestDmg = res.damage;
                        bestCombo = { 
                            s5: s5.id, 
                            s2: s2.id, 
                            label: `5号位[${s5.label}] + 2件套[${s2.label}]` 
                        };
                    }
                });
            });

            return { bestCombo, bestDmg, nakedDmg };
        }

        function updateDiskUI(analysis) {
            const { bestCombo, bestDmg, nakedDmg } = analysis;
            
            // Mark options
            const markOption = (selectId, bestId) => {
                const select = document.getElementById(selectId);
                Array.from(select.options).forEach(opt => {
                    // Reset text
                    opt.textContent = opt.textContent.replace(' [★]', '');
                    opt.classList.remove('best-opt');
                    if (opt.value === bestId && bestId !== 'none') {
                        opt.textContent += ' [★]';
                        opt.classList.add('best-opt');
                    }
                });
            };

            markOption('slot5_main', bestCombo.s5);
            markOption('set2_effect', bestCombo.s2);

            // Display
            const currentS5 = document.getElementById('slot5_main').value;
            const currentS2 = document.getElementById('set2_effect').value;
            
            diskDisplay.currentDmg.textContent = Math.round(calculateBaseDamage(applyDiskMod(getRawInputs(), currentS5, currentS2)).damage).toLocaleString();
            diskDisplay.bestCombo.textContent = bestCombo.label;
            
            if (nakedDmg > 0) {
                const gain = ((bestDmg - nakedDmg) / nakedDmg) * 100;
                diskDisplay.gainVal.textContent = '+' + gain.toFixed(2) + '%';
            }
        }

        function calculateDamage() {
            const baseStats = getRawInputs();
            
            // Get Disk Selection
            const s5 = document.getElementById('slot5_main').value;
            const s2 = document.getElementById('set2_effect').value;

            // Analyze Best Combo
            const analysis = calculateBestDiskCombo(baseStats);
            updateDiskUI(analysis);

            // Apply Current Selection for Final Calculation
            const effectiveStats = applyDiskMod(baseStats, s5, s2);
            
            const finalResult = calculateBaseDamage(effectiveStats);
            const finalDmg = finalResult.damage;

            animateValue(resultDisplay, parseInt(resultDisplay.textContent.replace(/,/g, '') || 0), Math.round(finalDmg), 300);
            
            defMultDisplay.textContent = finalResult.defMultiplier.toFixed(3);
            resMultDisplay.textContent = finalResult.resMultiplier.toFixed(3);
            
            if (finalResult.effectiveCritRate >= 1) {
                resultDisplay.style.color = '#ff3333';
                resultDisplay.style.textShadow = '4px 4px 0px rgba(255, 50, 50, 0.3)';
            } else {
                resultDisplay.style.color = 'var(--zzz-neon)';
                resultDisplay.style.textShadow = '4px 4px 0px rgba(255, 255, 255, 0.2)';
            }

            updateFormulaDisplay(effectiveStats, finalResult.finalAttack);
            calculateSubStatGains(effectiveStats, finalDmg);
            
            // 隐藏之前的模拟结果，因为面板变了
            simResults.classList.remove('show');
        }

        function calculateSubStatGains(currentStats, currentDamage) {
            if (currentDamage === 0) return;

            const gains = [];
            
            let s1 = { ...currentStats }; s1.critRate += 0.024;
            const g1 = ((calculateBaseDamage(s1).damage - currentDamage) / currentDamage) * 100;
            gains.push({ id: 'critRate', val: g1 });
            
            let s2 = { ...currentStats }; s2.critDmg += 0.048;
            const g2 = ((calculateBaseDamage(s2).damage - currentDamage) / currentDamage) * 100;
            gains.push({ id: 'critDmg', val: g2 });

            // Removed Pen calc from single gain display

            // Atk +3% (Outside)
            let s4 = { ...currentStats }; 
            s4.attack += (currentStats.baseAttack * 0.03); 
            const g4 = ((calculateBaseDamage(s4).damage - currentDamage) / currentDamage) * 100;
            gains.push({ id: 'atk', val: g4 });

            let maxVal = -999;
            let maxId = '';
            
            gains.forEach(item => {
                const elInfo = gainDisplays[item.id];
                elInfo.el.textContent = (item.val > 0 ? '+' : '') + item.val.toFixed(2) + '%';
                elInfo.el.className = 'gain-value ' + (item.val > 0 ? 'positive' : '');
                elInfo.container.classList.remove('best-gain');
                if (item.val > maxVal) { maxVal = item.val; maxId = item.id; }
            });

            if (maxId && maxVal > 0) {
                gainDisplays[maxId].container.classList.add('best-gain');
            }
        }
        
        // --- 自动迭代模拟核心逻辑 ---
        function runSimulation(selectedSteps) {
            const TOTAL_SIM_STEPS = 46;

            // 1. 获取当前生效的面板
            let baseStats = getRawInputs();
            const s5 = document.getElementById('slot5_main').value;
            const s2 = document.getElementById('set2_effect').value;
            baseStats = applyDiskMod(baseStats, s5, s2);
            
            // 初始伤害
            const startDmg = calculateBaseDamage(baseStats).damage;
            if (startDmg === 0) return;

            const counts = { critRate: 0, critDmg: 0, pen: 0, atk: 0 };
            
            // Data tracking
            const chartLabels = [];
            const dataCrit = [];
            const dataCD = [];
            const dataAtk = [];
            currentSimHistory = []; // Reset history

            let currentSimStats = { ...baseStats };
            let currentSimDmg = startDmg;

            // UI Snapshot Data
            let snapshotCounts = { ...counts };
            let snapshotFinalDmg = 0;

            for (let i = 0; i < TOTAL_SIM_STEPS; i++) {
                chartLabels.push(i + 1);

                // Calculate potential gains for next step
                let s1 = { ...currentSimStats }; s1.critRate += 0.024;
                const d1 = calculateBaseDamage(s1).damage;
                const g1 = ((d1 - currentSimDmg) / currentSimDmg) * 100;
                
                let s2 = { ...currentSimStats }; s2.critDmg += 0.048;
                const d2 = calculateBaseDamage(s2).damage;
                const g2 = ((d2 - currentSimDmg) / currentSimDmg) * 100;

                // Removed Pen variation

                let s4 = { ...currentSimStats }; s4.attack += (currentSimStats.baseAttack * 0.03);
                const d4 = calculateBaseDamage(s4).damage;
                const g4 = ((d4 - currentSimDmg) / currentSimDmg) * 100;

                dataCrit.push(g1);
                dataCD.push(g2);
                dataAtk.push(g4);

                // Choose best
                const variations = [
                    { id: 'critRate', stats: s1, dmg: d1 },
                    { id: 'critDmg', stats: s2, dmg: d2 },
                    { id: 'atk', stats: s4, dmg: d4 }
                ];

                let best = variations.reduce((prev, current) => (prev.dmg > current.dmg) ? prev : current);

                // Apply best to stats for next round
                currentSimStats = best.stats;
                currentSimDmg = best.dmg;
                counts[best.id]++;

                // Save history for tooltip
                currentSimHistory.push({
                    step: i + 1,
                    counts: { ...counts },
                    bestChoice: best.id
                });

                // If we reached the selected step count (e.g., 30), save snapshot for UI display
                if (i === selectedSteps - 1) {
                    snapshotCounts = { ...counts };
                    snapshotFinalDmg = currentSimDmg;
                    updateFinalStatsDisplay(currentSimStats, calculateBaseDamage(currentSimStats).finalAttack);
                }
            }

            // Update UI Summary based on Snapshot (Selected Step)
            simCountEls.critRate.textContent = snapshotCounts.critRate;
            simCountEls.critDmg.textContent = snapshotCounts.critDmg;
            simCountEls.atk.textContent = snapshotCounts.atk;

            simSummaryEls.steps.textContent = selectedSteps;
            simSummaryEls.startDmg.textContent = Math.round(startDmg).toLocaleString();
            simSummaryEls.finalDmg.textContent = Math.round(snapshotFinalDmg).toLocaleString();
            
            const increase = ((snapshotFinalDmg - startDmg) / startDmg) * 100;
            simSummaryEls.increase.textContent = '+' + increase.toFixed(2) + '%';

            simResults.classList.add('show');
            renderChart(chartLabels, dataCrit, dataCD, dataAtk, selectedSteps);
        }

        function updateFinalStatsDisplay(stats, finalAtkVal) {
            finalStatsEls.atk.textContent = Math.round(finalAtkVal);
            finalStatsEls.crit.textContent = (stats.critRate * 100).toFixed(1) + '%';
            finalStatsEls.cd.textContent = (stats.critDmg * 100).toFixed(1) + '%';
            finalStatsEls.pen.textContent = Math.round(stats.penValue);
            finalStatsEls.penRatio.textContent = (stats.penRatio * 100).toFixed(1) + '%';
            finalStatsEls.dmgBonus.textContent = (stats.dmgBonus * 100).toFixed(1) + '%';
        }

        function renderChart(labels, dCrit, dCD, dAtk, selectedStep) {
            const ctx = document.getElementById('gainChart').getContext('2d');
            
            if (gainChart) gainChart.destroy();

            const colorCrit = '#ff0055';
            const colorCD = '#00ff9d';
            const colorAtk = '#00ccff';

            // Custom Plugin to draw vertical line
            const verticalLinePlugin = {
                id: 'verticalLine',
                afterDraw: (chart) => {
                    const idx = selectedStep - 1; // 0-based index
                    if (idx < 0) return;
                    
                    const ctx = chart.ctx;
                    const xAxis = chart.scales.x;
                    const yAxis = chart.scales.y;
                    
                    // Chart.js stores data points. We need the pixel for the specific label index.
                    const xPos = xAxis.getPixelForValue(idx + 1); // +1 because labels are 1-based integers
                    
                    ctx.save();
                    ctx.beginPath();
                    ctx.moveTo(xPos, yAxis.top);
                    ctx.lineTo(xPos, yAxis.bottom);
                    ctx.lineWidth = 1;
                    ctx.strokeStyle = '#ffffff';
                    ctx.setLineDash([5, 5]);
                    ctx.stroke();
                    ctx.restore();
                }
            };

            gainChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Crit Rate', data: dCrit, borderColor: colorCrit, backgroundColor: colorCrit, borderWidth: 2, pointRadius: 1, tension: 0.3 },
                        { label: 'Crit DMG', data: dCD, borderColor: colorCD, backgroundColor: colorCD, borderWidth: 2, pointRadius: 1, tension: 0.3 },
                        { label: 'Atk', data: dAtk, borderColor: colorAtk, backgroundColor: colorAtk, borderWidth: 2, pointRadius: 1, tension: 0.3 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { labels: { color: '#ccc', font: { family: 'monospace' } } },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.9)',
                            titleColor: '#fff',
                            bodyColor: '#ccc',
                            borderColor: '#333',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) { return context.dataset.label + ': +' + context.parsed.y.toFixed(3) + '%'; },
                                afterBody: function(tooltipItems) {
                                    const index = tooltipItems[0].dataIndex;
                                    const hist = currentSimHistory[index];
                                    if (hist) {
                                        return '\n最佳搭配 (Best Alloc):\n' +
                                               '暴击: ' + hist.counts.critRate + ' | 爆伤: ' + hist.counts.critDmg + '\n' +
                                               '攻击: ' + hist.counts.atk;
                                    }
                                    return '';
                                }
                            }
                        }
                    },
                    scales: {
                        x: { display: true, grid: { color: '#222' }, ticks: { color: '#666' } },
                        y: { display: true, grid: { color: '#222' }, ticks: { color: '#666' } }
                    }
                },
                plugins: [verticalLinePlugin]
            });
        }

        function updateFormulaDisplay(stats, finalAttack) {
            const hl = (val, unit='') => `<span class="highlight">${val}${unit}</span>`;
            const p = (v) => (v * 100).toFixed(1);
            const n = (v) => Math.round(v);

            let formulaStr = `伤害 = ${hl(p(stats.skillMult), '%')} * ${hl(n(finalAttack))} * (1+${hl(p(stats.dmgBonus), '%')}) * <br>` +
                             `(1 + ${hl(p(stats.critRate), '%')} * (1 + ${hl(p(stats.critDmg), '%')})) * <br>` +
                             `(1 - ${hl(p(stats.enemyRes), '%')} + ${hl(p(stats.enemyWeakness), '%')} + ${hl(p(stats.agentResRed), '%')}) * <br>` +
                             `(794 / ((${hl(stats.baseDef)} * (1 + ${hl(p(stats.defBonus), '%')} - ${hl(p(stats.defShred), '%')})) * (1 - ${hl(p(stats.penRatio), '%')}) - ${hl(stats.penValue)} + 794)) * <br>` +
                             `(1 + ${hl(p(stats.stunMult), '%')})`;

            formulaDisplay.innerHTML = formulaStr;
        }

        function animateValue(obj, start, end, duration) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                const currentVal = Math.floor(progress * (end - start) + start);
                obj.innerHTML = currentVal.toLocaleString();
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        }

        inputs.forEach(input => {
            input.addEventListener('input', calculateDamage);
            if (input.type === 'number') {
                input.addEventListener('focus', function() { this.parentElement.style.borderColor = 'var(--zzz-neon)'; });
                input.addEventListener('blur', function() { this.parentElement.style.borderColor = '#444'; });
            }
        });

        // Initialize
        toggleWeakness(document.querySelector('.toggle-container')); 
    </script>
</body>
</html>
